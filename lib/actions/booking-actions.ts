"use server";

import { sendEmail, isValidEmail, sanitizeHtml } from "@/lib/email/smtp";
import connectToDatabase from "@/lib/db/mongodb";
import Booking from "@/lib/db/models/Booking";

interface BookingFormData {
  fullName: string;
  email: string;
  phone: string;
  deviceType: string;
  serviceId: string;
  problemDescription: string;
  preferredDate: string;
  preferredTime: string;
}

function validateBookingForm(formData: BookingFormData): {
  isValid: boolean;
  errors: string[];
} {
  const errors: string[] = [];

  // Validate required fields
  if (!formData.fullName || formData.fullName.trim().length < 2) {
    errors.push("H·ªç t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±");
  }

  if (!formData.email || !isValidEmail(formData.email)) {
    errors.push("Email kh√¥ng h·ª£p l·ªá");
  }

  if (!formData.phone || formData.phone.trim().length < 10) {
    errors.push("S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ √≠t nh·∫•t 10 s·ªë");
  }

  if (!formData.deviceType) {
    errors.push("Vui l√≤ng ch·ªçn lo·∫°i thi·∫øt b·ªã");
  }

  if (!formData.serviceId) {
    errors.push("Vui l√≤ng ch·ªçn d·ªãch v·ª•");
  }

  if (
    !formData.problemDescription ||
    formData.problemDescription.trim().length < 10
  ) {
    errors.push("M√¥ t·∫£ v·∫•n ƒë·ªÅ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±");
  }

  if (!formData.preferredDate) {
    errors.push("Vui l√≤ng ch·ªçn ng√†y h·∫πn");
  }

  if (!formData.preferredTime) {
    errors.push("Vui l√≤ng ch·ªçn gi·ªù h·∫πn");
  }

  // Validate date is not in the past
  const selectedDate = new Date(formData.preferredDate);
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  if (selectedDate < today) {
    errors.push("Ng√†y h·∫πn kh√¥ng th·ªÉ l√† ng√†y trong qu√° kh·ª©");
  }

  return {
    isValid: errors.length === 0,
    errors,
  };
}

function formatDate(date: Date): string {
  return date.toLocaleDateString("vi-VN", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

function getDeviceTypeName(deviceType: string): string {
  const deviceTypes: Record<string, string> = {
    macbook: "MacBook",
    "macbook-pro": "MacBook Pro",
    "macbook-air": "MacBook Air",
    "windows-laptop": "Laptop Windows",
    "gaming-laptop": "Laptop Gaming",
    other: "Kh√°c",
  };
  return deviceTypes[deviceType] || deviceType;
}

export async function submitBookingForm(formData: BookingFormData) {
  try {
    // Validate form data
    const validation = validateBookingForm(formData);
    if (!validation.isValid) {
      return {
        success: false,
        message: validation.errors.join(", "),
      };
    }

    // Check if required environment variables are configured
    if (!process.env.TO_EMAIL) {
      console.error("TO_EMAIL environment variable is not configured");
      return {
        success: false,
        message: "C·∫•u h√¨nh email ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p",
      };
    }

    // Sanitize user input
    const sanitizedData = {
      fullName: sanitizeHtml(formData.fullName.trim()),
      email: formData.email.trim().toLowerCase(),
      phone: sanitizeHtml(formData.phone.trim()),
      deviceType: formData.deviceType,
      serviceId: sanitizeHtml(formData.serviceId),
      problemDescription: sanitizeHtml(formData.problemDescription.trim()),
      preferredDate: formData.preferredDate,
      preferredTime: formData.preferredTime,
    };

    // Save booking to database
    await connectToDatabase();
    const booking = new Booking({
      name: sanitizedData.fullName,
      email: sanitizedData.email,
      phone: sanitizedData.phone,
      deviceType: sanitizedData.deviceType,
      serviceId: sanitizedData.serviceId,
      problemDescription: sanitizedData.problemDescription,
      preferredDate: new Date(sanitizedData.preferredDate),
      preferredTime: sanitizedData.preferredTime,
      status: "pending",
    });

    await booking.save();

    const formattedDate = formatDate(new Date(sanitizedData.preferredDate));
    const deviceTypeName = getDeviceTypeName(sanitizedData.deviceType);

    // Create customer confirmation email with brand colors
    const customerHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eaeaea; border-radius: 8px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="background: linear-gradient(135deg, #FACC15 0%, #F59E0B 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h1 style="color: #000; margin: 0; font-size: 28px; font-weight: bold;">‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa</h1>
            <p style="color: #000; margin: 8px 0 0 0; font-size: 16px;">LaptopSun - Nhanh ch√≥ng, Chu·∫©n x√°c, ƒê√∫ng h·∫πn</p>
          </div>
        </div>
        
        <p style="font-size: 16px; margin-bottom: 20px;">Xin ch√†o <strong style="color: #FACC15;">${
          sanitizedData.fullName
        }</strong>,</p>
        <p style="font-size: 16px; margin-bottom: 20px;">C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa v·ªõi <strong style="color: #FACC15;">LaptopSun</strong>. Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu c·ªßa b·∫°n v√† s·∫Ω li√™n h·ªá s·ªõm nh·∫•t ƒë·ªÉ x√°c nh·∫≠n.</p>
        
        <div style="background-color: #f8f9fa; padding: 25px; border-radius: 12px; margin: 25px 0; border-left: 4px solid #FACC15;">
          <h3 style="color: #333; margin-top: 0; border-bottom: 2px solid #FACC15; padding-bottom: 10px; font-size: 20px;">üìã Th√¥ng tin ƒë·∫∑t l·ªãch</h3>
          
          <div style="margin-bottom: 20px;">
            <strong style="color: #FACC15;">üë§ Th√¥ng tin kh√°ch h√†ng:</strong><br>
            <div style="margin-left: 20px; margin-top: 8px;">
              ‚Ä¢ <strong>H·ªç v√† t√™n:</strong> ${sanitizedData.fullName}<br>
              ‚Ä¢ <strong>Email:</strong> ${sanitizedData.email}<br>
              ‚Ä¢ <strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${sanitizedData.phone}
            </div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <strong style="color: #FACC15;">üíª Th√¥ng tin thi·∫øt b·ªã:</strong><br>
            <div style="margin-left: 20px; margin-top: 8px;">
              ‚Ä¢ <strong>Lo·∫°i thi·∫øt b·ªã:</strong> ${deviceTypeName}<br>
              ‚Ä¢ <strong>D·ªãch v·ª•:</strong> ${sanitizedData.serviceId}<br>
              ‚Ä¢ <strong>M√¥ t·∫£ v·∫•n ƒë·ªÅ:</strong> ${
                sanitizedData.problemDescription
              }
            </div>
          </div>
          
          <div>
            <strong style="color: #FACC15;">üìÖ Th·ªùi gian h·∫πn:</strong><br>
            <div style="margin-left: 20px; margin-top: 8px;">
              ‚Ä¢ <strong>Ng√†y:</strong> ${formattedDate}<br>
              ‚Ä¢ <strong>Gi·ªù:</strong> ${sanitizedData.preferredTime}
            </div>
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 20px; border-radius: 12px; margin: 25px 0; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 15px; line-height: 1.6;">
            <strong style="color: #1976d2;">üìû B∆∞·ªõc ti·∫øp theo:</strong><br>
            Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong v√≤ng <strong>2-4 gi·ªù l√†m vi·ªác</strong> ƒë·ªÉ x√°c nh·∫≠n l·ªãch h·∫πn v√† cung c·∫•p th√™m th√¥ng tin chi ti·∫øt v·ªÅ d·ªãch v·ª•.
          </p>
        </div>
        
        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 14px; border-top: 2px solid #FACC15; padding-top: 20px;">
          <div style="background-color: #FACC15; color: #000; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
            <p style="margin: 0; font-weight: bold; font-size: 16px;">
              üè™ LaptopSun - Chuy√™n gia s·ª≠a ch·ªØa laptop
            </p>
          </div>
          <p style="margin: 5px 0;">
            üìß Email: ${process.env.TO_EMAIL || "booking@laptopsun.vn"}<br>
            üì± Hotline: 0857 270 270<br>
            üè† ƒê·ªãa ch·ªâ: 995 CMT8, Ph∆∞·ªùng 7, Qu·∫≠n T√¢n B√¨nh, TP.HCM
          </p>
        </div>
      </div>
    `;

    // Create admin notification email with brand colors
    const adminHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eaeaea; border-radius: 8px;">
        <div style="background: linear-gradient(135deg, #FACC15 0%, #F59E0B 100%); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
          <h2 style="color: #000; margin: 0; text-align: center; font-size: 24px; font-weight: bold;">üîî ƒê∆†N ƒê·∫∂T L·ªäCH M·ªöI</h2>
          <p style="color: #000; margin: 8px 0 0 0; text-align: center; font-size: 14px;">LaptopSun - H·ªá th·ªëng qu·∫£n l√Ω</p>
        </div>
        
        <div style="background-color: #f8f9fa; padding: 25px; border-radius: 12px; border-left: 4px solid #FACC15;">
          <h3 style="color: #333; margin-top: 0; border-bottom: 2px solid #FACC15; padding-bottom: 10px; font-size: 18px;">üë§ Th√¥ng tin kh√°ch h√†ng</h3>
          <div style="margin-left: 15px;">
            <p><strong>H·ªç v√† t√™n:</strong> <span style="color: #FACC15;">${
              sanitizedData.fullName
            }</span></p>
            <p><strong>Email:</strong> ${sanitizedData.email}</p>
            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${sanitizedData.phone}</p>
          </div>
          
          <h3 style="color: #333; border-bottom: 2px solid #FACC15; padding-bottom: 10px; font-size: 18px; margin-top: 25px;">üíª Th√¥ng tin thi·∫øt b·ªã</h3>
          <div style="margin-left: 15px;">
            <p><strong>Lo·∫°i thi·∫øt b·ªã:</strong> <span style="color: #FACC15;">${deviceTypeName}</span></p>
            <p><strong>D·ªãch v·ª•:</strong> ${sanitizedData.serviceId}</p>
            <p><strong>M√¥ t·∫£ v·∫•n ƒë·ªÅ:</strong> ${
              sanitizedData.problemDescription
            }</p>
          </div>
          
          <h3 style="color: #333; border-bottom: 2px solid #FACC15; padding-bottom: 10px; font-size: 18px; margin-top: 25px;">üìÖ Th·ªùi gian h·∫πn</h3>
          <div style="margin-left: 15px;">
            <p><strong>Ng√†y:</strong> <span style="color: #FACC15;">${formattedDate}</span></p>
            <p><strong>Gi·ªù:</strong> <span style="color: #FACC15;">${
              sanitizedData.preferredTime
            }</span></p>
          </div>
        </div>
        
        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px; border-radius: 12px; margin-top: 25px; border-left: 4px solid #ffc107;">
          <p style="margin: 0; font-size: 15px; line-height: 1.6;">
            <strong style="color: #856404;">‚ö†Ô∏è H√†nh ƒë·ªông c·∫ßn thi·∫øt:</strong><br>
            Vui l√≤ng li√™n h·ªá v·ªõi kh√°ch h√†ng trong v√≤ng <strong>2-4 gi·ªù</strong> ƒë·ªÉ x√°c nh·∫≠n l·ªãch h·∫πn.<br>
            <strong>ID Booking:</strong> <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${
              booking._id
            }</code>
          </p>
        </div>
        
        <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px; line-height: 1.6;">
            <strong style="color: #1976d2;">üìÖ Th·ªùi gian nh·∫≠n:</strong> ${new Date().toLocaleString(
              "vi-VN"
            )}<br>
            <strong style="color: #1976d2;">üåê Ngu·ªìn:</strong> Website LaptopSun<br>
            <strong style="color: #1976d2;">üìß Email kh√°ch h√†ng:</strong> ${
              sanitizedData.email
            }
          </p>
        </div>
      </div>
    `;

    // Send emails
    const emailPromises = [];

    // Send confirmation email to customer
    emailPromises.push(
      sendEmail({
        to: sanitizedData.email,
        subject: "‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa - LaptopSun",
        html: customerHtml,
      })
    );

    // Send notification email to admin
    emailPromises.push(
      sendEmail({
        to: process.env.TO_EMAIL,
        subject: "üîî ƒê∆°n ƒë·∫∑t l·ªãch m·ªõi t·ª´ Website - LaptopSun",
        html: adminHtml,
      })
    );

    const [customerResult, adminResult] = await Promise.all(emailPromises);

    // Check if at least one email was sent successfully
    if (customerResult.success || adminResult.success) {
      let message = "ƒê·∫∑t l·ªãch th√†nh c√¥ng!";

      if (customerResult.success && adminResult.success) {
        message += " Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i.";
      } else if (customerResult.success) {
        message += " Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i cho b·∫°n.";
      } else if (adminResult.success) {
        message += " Th√¥ng tin ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn h·ªá th·ªëng.";
      }

      return {
        success: true,
        message,
        bookingId: booking._id.toString(),
        customerEmailId: customerResult.messageId,
        adminEmailId: adminResult.messageId,
      };
    } else {
      return {
        success: false,
        message:
          "ƒê·∫∑t l·ªãch th√†nh c√¥ng nh∆∞ng c√≥ l·ªói khi g·ª≠i email x√°c nh·∫≠n. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.",
      };
    }
  } catch (error) {
    console.error("Error in submitBookingForm:", error);
    return {
      success: false,
      message: "C√≥ l·ªói h·ªá th·ªëng x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.",
    };
  }
}
