"use server"

import { sendEmail, isValidEmail, sanitizeHtml } from "@/lib/email/smtp"
import connectToDatabase from "@/lib/db/mongodb"
import Booking from "@/lib/db/models/Booking"

interface BookingFormData {
  fullName: string
  email: string
  phone: string
  deviceType: string
  serviceId: string
  problemDescription: string
  preferredDate: string
  preferredTime: string
}

function validateBookingForm(formData: BookingFormData): { isValid: boolean; errors: string[] } {
  const errors: string[] = []

  // Validate required fields
  if (!formData.fullName || formData.fullName.trim().length < 2) {
    errors.push("H·ªç t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±")
  }

  if (!formData.email || !isValidEmail(formData.email)) {
    errors.push("Email kh√¥ng h·ª£p l·ªá")
  }

  if (!formData.phone || formData.phone.trim().length < 10) {
    errors.push("S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ √≠t nh·∫•t 10 s·ªë")
  }

  if (!formData.deviceType) {
    errors.push("Vui l√≤ng ch·ªçn lo·∫°i thi·∫øt b·ªã")
  }

  if (!formData.serviceId) {
    errors.push("Vui l√≤ng ch·ªçn d·ªãch v·ª•")
  }

  if (!formData.problemDescription || formData.problemDescription.trim().length < 10) {
    errors.push("M√¥ t·∫£ v·∫•n ƒë·ªÅ ph·∫£i c√≥ √≠t nh·∫•t 10 k√Ω t·ª±")
  }

  if (!formData.preferredDate) {
    errors.push("Vui l√≤ng ch·ªçn ng√†y h·∫πn")
  }

  if (!formData.preferredTime) {
    errors.push("Vui l√≤ng ch·ªçn gi·ªù h·∫πn")
  }

  // Validate date is not in the past
  const selectedDate = new Date(formData.preferredDate)
  const today = new Date()
  today.setHours(0, 0, 0, 0)

  if (selectedDate < today) {
    errors.push("Ng√†y h·∫πn kh√¥ng th·ªÉ l√† ng√†y trong qu√° kh·ª©")
  }

  return {
    isValid: errors.length === 0,
    errors,
  }
}

function formatDate(date: Date): string {
  return date.toLocaleDateString("vi-VN", {
    weekday: "long",
    year: "numeric",
    month: "long",
    day: "numeric",
  })
}

function getDeviceTypeName(deviceType: string): string {
  const deviceTypes: Record<string, string> = {
    macbook: "MacBook",
    "macbook-pro": "MacBook Pro",
    "macbook-air": "MacBook Air",
    "windows-laptop": "Laptop Windows",
    "gaming-laptop": "Laptop Gaming",
    other: "Kh√°c",
  }
  return deviceTypes[deviceType] || deviceType
}

export async function submitBookingForm(formData: BookingFormData) {
  try {
    // Validate form data
    const validation = validateBookingForm(formData)
    if (!validation.isValid) {
      return {
        success: false,
        message: validation.errors.join(", "),
      }
    }

    // Check if required environment variables are configured
    if (!process.env.TO_EMAIL) {
      console.error("TO_EMAIL environment variable is not configured")
      return {
        success: false,
        message: "C·∫•u h√¨nh email ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p",
      }
    }

    // Sanitize user input
    const sanitizedData = {
      fullName: sanitizeHtml(formData.fullName.trim()),
      email: formData.email.trim().toLowerCase(),
      phone: sanitizeHtml(formData.phone.trim()),
      deviceType: formData.deviceType,
      serviceId: sanitizeHtml(formData.serviceId),
      problemDescription: sanitizeHtml(formData.problemDescription.trim()),
      preferredDate: formData.preferredDate,
      preferredTime: formData.preferredTime,
    }

    // Save booking to database
    await connectToDatabase()
    const booking = new Booking({
      name: sanitizedData.fullName,
      email: sanitizedData.email,
      phone: sanitizedData.phone,
      deviceType: sanitizedData.deviceType,
      serviceId: sanitizedData.serviceId,
      problemDescription: sanitizedData.problemDescription,
      preferredDate: new Date(sanitizedData.preferredDate),
      preferredTime: sanitizedData.preferredTime,
      status: "pending",
    })

    await booking.save()

    const formattedDate = formatDate(new Date(sanitizedData.preferredDate))
    const deviceTypeName = getDeviceTypeName(sanitizedData.deviceType)

    // Create customer confirmation email
    const customerHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eaeaea; border-radius: 8px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="background-color: #FACC15; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
            <h1 style="color: #000; margin: 0; font-size: 24px;">‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa</h1>
          </div>
        </div>
        
        <p style="font-size: 16px; margin-bottom: 20px;">Xin ch√†o <strong>${sanitizedData.fullName}</strong>,</p>
        <p style="font-size: 16px; margin-bottom: 20px;">C·∫£m ∆°n b·∫°n ƒë√£ ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa v·ªõi <strong>LaptopSun</strong>. Ch√∫ng t√¥i ƒë√£ nh·∫≠n ƒë∆∞·ª£c y√™u c·∫ßu c·ªßa b·∫°n v√† s·∫Ω li√™n h·ªá s·ªõm nh·∫•t ƒë·ªÉ x√°c nh·∫≠n.</p>
        
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
          <h3 style="color: #333; margin-top: 0; border-bottom: 2px solid #FACC15; padding-bottom: 8px;">üìã Th√¥ng tin ƒë·∫∑t l·ªãch</h3>
          
          <div style="margin-bottom: 15px;">
            <strong>üë§ Th√¥ng tin kh√°ch h√†ng:</strong><br>
            ‚Ä¢ H·ªç v√† t√™n: ${sanitizedData.fullName}<br>
            ‚Ä¢ Email: ${sanitizedData.email}<br>
            ‚Ä¢ S·ªë ƒëi·ªán tho·∫°i: ${sanitizedData.phone}
          </div>
          
          <div style="margin-bottom: 15px;">
            <strong>üíª Th√¥ng tin thi·∫øt b·ªã:</strong><br>
            ‚Ä¢ Lo·∫°i thi·∫øt b·ªã: ${deviceTypeName}<br>
            ‚Ä¢ D·ªãch v·ª•: ${sanitizedData.serviceId}<br>
            ‚Ä¢ M√¥ t·∫£ v·∫•n ƒë·ªÅ: ${sanitizedData.problemDescription}
          </div>
          
          <div>
            <strong>üìÖ Th·ªùi gian h·∫πn:</strong><br>
            ‚Ä¢ Ng√†y: ${formattedDate}<br>
            ‚Ä¢ Gi·ªù: ${sanitizedData.preferredTime}
          </div>
        </div>
        
        <div style="background-color: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;">
            <strong>üìû B∆∞·ªõc ti·∫øp theo:</strong><br>
            Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong v√≤ng 2-4 gi·ªù l√†m vi·ªác ƒë·ªÉ x√°c nh·∫≠n l·ªãch h·∫πn v√† cung c·∫•p th√™m th√¥ng tin chi ti·∫øt.
          </p>
        </div>
        
        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 14px; border-top: 1px solid #eee; padding-top: 20px;">
          <p style="margin: 0;">
            <strong>LaptopSun - Chuy√™n gia s·ª≠a ch·ªØa laptop</strong><br>
            üìß Email: ${process.env.TO_EMAIL}<br>
            üì± Hotline: 1900-xxxx
          </p>
        </div>
      </div>
    `

    // Create admin notification email
    const adminHtml = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #eaeaea; border-radius: 8px;">
        <div style="background-color: #FACC15; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
          <h2 style="color: #000; margin: 0; text-align: center;">üîî ƒê∆†N ƒê·∫∂T L·ªäCH M·ªöI</h2>
        </div>
        
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px;">
          <h3 style="color: #333; margin-top: 0; border-bottom: 2px solid #FACC15; padding-bottom: 8px;">üë§ Th√¥ng tin kh√°ch h√†ng</h3>
          <p><strong>H·ªç v√† t√™n:</strong> ${sanitizedData.fullName}</p>
          <p><strong>Email:</strong> ${sanitizedData.email}</p>
          <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${sanitizedData.phone}</p>
          
          <h3 style="color: #333; border-bottom: 2px solid #FACC15; padding-bottom: 8px;">üíª Th√¥ng tin thi·∫øt b·ªã</h3>
          <p><strong>Lo·∫°i thi·∫øt b·ªã:</strong> ${deviceTypeName}</p>
          <p><strong>D·ªãch v·ª•:</strong> ${sanitizedData.serviceId}</p>
          <p><strong>M√¥ t·∫£ v·∫•n ƒë·ªÅ:</strong> ${sanitizedData.problemDescription}</p>
          
          <h3 style="color: #333; border-bottom: 2px solid #FACC15; padding-bottom: 8px;">üìÖ Th·ªùi gian h·∫πn</h3>
          <p><strong>Ng√†y:</strong> ${formattedDate}</p>
          <p><strong>Gi·ªù:</strong> ${sanitizedData.preferredTime}</p>
        </div>
        
        <div style="background-color: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ffc107;">
          <p style="margin: 0; font-size: 14px;">
            <strong>‚ö†Ô∏è H√†nh ƒë·ªông c·∫ßn thi·∫øt:</strong><br>
            Vui l√≤ng li√™n h·ªá v·ªõi kh√°ch h√†ng trong v√≤ng 2-4 gi·ªù ƒë·ªÉ x√°c nh·∫≠n l·ªãch h·∫πn.<br>
            <strong>ID Booking:</strong> ${booking._id}
          </p>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; font-size: 14px;">
            <strong>üìÖ Th·ªùi gian nh·∫≠n:</strong> ${new Date().toLocaleString("vi-VN")}<br>
            <strong>üåê Ngu·ªìn:</strong> Website LaptopSun
          </p>
        </div>
      </div>
    `

    // Send emails
    const emailPromises = []

    // Send confirmation email to customer
    emailPromises.push(
      sendEmail({
        to: sanitizedData.email,
        subject: "‚úÖ X√°c nh·∫≠n ƒë·∫∑t l·ªãch s·ª≠a ch·ªØa - LaptopSun",
        html: customerHtml,
      }),
    )

    // Send notification email to admin
    emailPromises.push(
      sendEmail({
        to: process.env.TO_EMAIL,
        subject: "New Booking Received",
        html: adminHtml,
      }),
    )

    const [customerResult, adminResult] = await Promise.all(emailPromises)

    // Check if at least one email was sent successfully
    if (customerResult.success || adminResult.success) {
      let message = "ƒê·∫∑t l·ªãch th√†nh c√¥ng!"

      if (customerResult.success && adminResult.success) {
        message += " Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i."
      } else if (customerResult.success) {
        message += " Email x√°c nh·∫≠n ƒë√£ ƒë∆∞·ª£c g·ª≠i cho b·∫°n."
      } else if (adminResult.success) {
        message += " Th√¥ng tin ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn h·ªá th·ªëng."
      }

      return {
        success: true,
        message,
        bookingId: booking._id.toString(),
        customerEmailId: customerResult.messageId,
        adminEmailId: adminResult.messageId,
      }
    } else {
      return {
        success: false,
        message: "ƒê·∫∑t l·ªãch th√†nh c√¥ng nh∆∞ng c√≥ l·ªói khi g·ª≠i email x√°c nh·∫≠n. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá v·ªõi b·∫°n s·ªõm nh·∫•t.",
      }
    }
  } catch (error) {
    console.error("Error in submitBookingForm:", error)
    return {
      success: false,
      message: "C√≥ l·ªói h·ªá th·ªëng x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i sau.",
    }
  }
}
